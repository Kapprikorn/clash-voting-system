<div class="container mt-4">
  <h2>League of Legends Champion Voting</h2>

  @if (currentSessionId) {
    <div class="alert alert-info">
      <strong>Current Session:</strong> {{ currentSessionId }}
    </div>
  }

  <app-login (adminStatusChange)="onAdminStatusChange($event)" />

  <!-- Login Required Message -->
  @if (!currentUser) {
    <div class="alert alert-warning mt-4">
      <i class="fas fa-sign-in-alt"></i> Please sign in to vote and participate in the poll!
    </div>
  }

  <!-- User Vote Summary -->
  @if (currentUser && getUserVoteCount() > 0) {
    <div class="alert alert-success mt-4">
      <i class="fas fa-check-circle"></i> You have voted for <strong>{{ getUserVoteCount() }}</strong> champion(s).
                                          You can vote once per champion!
    </div>
  }

  <!-- Admin Controls -->
  @if (isAdmin) {
    <div class="card mt-4 border-warning">
      <div class="card-header bg-warning">
        <h5>Admin Controls</h5>
      </div>
      <div class="card-body">
        <button
          class="btn btn-danger"
          (click)="clearAllChampions()"
          [disabled]="isLoading">
          Start New Session (Archive Current)
        </button>
        <small class="form-text text-muted">
          This will create a new voting session and archive the current one.
        </small>
      </div>
    </div>
  }

  <!-- Add Champion -->
  @if (isAdmin) {
    <div class="card mt-4">
      <div class="card-header">
        <h4>Add New Champion</h4>
      </div>
      <div class="card-body">
        <form (ngSubmit)="addChampion()" #championForm="ngForm">
          <div class="mb-3">
            <label for="championName" class="form-label">Champion Name</label>
            <select
              id="championName"
              class="form-select"
              [(ngModel)]="championName"
              name="championName"
              required
              [disabled]="isLoading || availableChampions.length === 0">

              <option value="" disabled>
                @if (availableChampions.length === 0) {
                  Loading champions...
                } @else {
                  Select a champion
                }
              </option>

              @for (championName of availableChampions; track championName) {
                <option [value]="championName.name">{{ championName.name }}</option>
              }
            </select>

            @if (availableChampions.length === 0) {
              <small class="form-text text-muted">
                <i class="fas fa-spinner fa-spin"></i> Loading champion list from League of Legends API...
              </small>
            }
          </div>

          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isLoading || !championName || availableChampions.length === 0">
            @if (isLoading) {
              <span class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </span>
            }
            {{ isLoading ? 'Adding...' : 'Add Champion' }}
          </button>
        </form>

        <!-- Success Message -->
        @if (successMessage) {
          <div class="alert alert-success mt-3" role="alert">
            {{ successMessage }}
          </div>
        }

        <!-- Error Message -->
        @if (errorMessage) {
          <div class="alert alert-danger mt-3" role="alert">
            {{ errorMessage }}
          </div>
        }
      </div>
    </div>
  }

  <!-- Voting Section -->
  @if (champions.length > 0) {
    <div class="card mt-4">
      <div class="card-header">
        <h4>Vote for Champions ({{ champions.length }} available)</h4>
        <p class="mb-0 text-muted">You can vote once per champion. Click vote again to remove your vote.</p>
      </div>
      <div class="card-body">
        <div class="row">
          @for (champion of champions; track champion.id) {
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card h-100 border"
                   [class.border-success]="hasUserVotedFor(champion.id)"
                   [class.bg-light]="hasUserVotedFor(champion.id)">
                <div class="card-body d-flex flex-column">
                  <!-- Champion Image and Name -->
                  <div class="d-flex align-items-center mb-3">
                    <img
                      [ngSrc]="getChampionImageByName(champion.name)"
                      [alt]="champion.name"
                      class="champion-image me-3"
                      width="100"
                      height="100"
                      style="object-fit: cover; border-radius: 8px;"
                    >
                    <div>
                      <h5 class="card-title mb-1">{{ champion.name }}</h5>
                    </div>
                  </div>

                  <div class="mt-auto">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="badge bg-primary fs-6">{{ champion.voteCount }} votes</span>
                      @if (hasUserVotedFor(champion.id)) {
                        <i class="fas fa-check-circle text-success"></i>
                      }
                    </div>

                    <!-- Vote Progress Bar -->
                    <div class="progress mb-2" style="height: 8px;">
                      <div class="progress-bar bg-primary"
                           [style.width.%]="getVotePercentage(champion.voteCount)">
                      </div>
                    </div>

                    @if (hasUserVotedFor(champion.id)) {
                      <!-- Unvote Button -->
                      <button
                        class="btn btn-outline-danger w-100"
                        [disabled]="isVoting"
                        (click)="unvote(champion.id, champion.name)">

                        @if (isVoting && votingFor === champion.id) {
                          <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                          Removing...
                        } @else {
                          <i class="fas fa-times me-2"></i>Remove Vote
                        }
                      </button>
                    } @else {
                      <!-- Vote Button -->
                      <button
                        class="btn w-100"
                        [class.btn-outline-primary]="currentUser"
                        [class.btn-outline-secondary]="!currentUser"
                        [disabled]="isVoting || !currentUser"
                        (click)="vote(champion.id, champion.name)">

                        @if (isVoting && votingFor === champion.id) {
                          <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                          Voting...
                        } @else {
                          @if (!currentUser) {
                            <i class="fas fa-lock me-2"></i>Sign in to Vote
                          } @else {
                            <i class="fas fa-vote-yea me-2"></i>Vote
                          }
                        }
                      </button>
                    }
                  </div>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Rest of your voting statistics section remains the same -->
        <div class="mt-4 p-3 bg-light rounded">
          <h6>Voting Statistics</h6>
          <div class="row text-center">
            <div class="col">
              <div class="h4 mb-0 text-primary">{{ getTotalVotes() }}</div>
              <small class="text-muted">Total Votes</small>
            </div>
            <div class="col">
              <div class="h4 mb-0 text-success">{{ getLeadingChampion()?.name || 'None' }}</div>
              <small class="text-muted">Leading Champion</small>
            </div>
            @if (currentUser) {
              <div class="col">
                <div class="h4 mb-0 text-info">{{ getUserVoteCount() }}</div>
                <small class="text-muted">Your Votes</small>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  } @else {
    <div class="card mt-4">
      <div class="card-body text-center">
        <h5>No Champions Available</h5>
        <p class="text-muted">Ask an admin to add some champions to start voting!</p>
      </div>
    </div>
  }
</div>
